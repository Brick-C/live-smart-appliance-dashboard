<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live Smart Appliance Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
      }
      .card {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -2px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }
    </style>
  </head>
  <body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
      <header class="text-center mb-10 p-4 bg-white rounded-xl card">
        <h1 class="text-4xl font-extrabold text-blue-800">
          Live Appliance Energy Monitor
        </h1>
        <!-- UPDATED HEADER TEXT -->
        <p class="text-lg text-gray-600 mt-2">
          Connecting to Secure Netlify API Function
        </p>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Real-Time Data Card -->
        <div
          class="lg:col-span-1 p-6 bg-white rounded-xl card h-full flex flex-col justify-between"
        >
          <div>
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">
              Appliance Status
            </h2>
            <div class="space-y-4">
              <div
                class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
              >
                <span class="font-medium text-gray-700">Device:</span>
                <select
                  id="device-selector"
                  class="form-select rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500"
                  onchange="changeDevice(this.value)"
                >
                  <option value="">Loading devices...</option>
                </select>
              </div>
              <div
                class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
              >
                <span class="font-medium text-gray-700">Location:</span>
                <span class="font-semibold text-blue-600" id="device-location"
                  >--</span
                >
              </div>
              <div
                class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
              >
                <span class="font-medium text-gray-700">Device Control:</span>
                <button
                  id="toggle-button"
                  class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors"
                  onclick="toggleDevice()"
                >
                  Turn OFF
                </button>
              </div>
              <div
                class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
              >
                <span class="font-medium text-gray-700"
                  >Current Power Draw:</span
                >
                <span
                  class="text-2xl font-extrabold text-green-600"
                  id="current-watts"
                  >0 W</span
                >
              </div>
              <div
                class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
              >
                <span class="font-medium text-gray-700">Total Energy:</span>
                <span
                  class="text-2xl font-extrabold text-purple-600"
                  id="total-kwh"
                  >0.00 kWh</span
                >
              </div>
              <div
                class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
              >
                <span class="font-medium text-gray-700">Current Rate:</span>
                <span class="text-xl font-bold text-gray-800" id="rate-per-kwh"
                  >$0.00/kWh</span
                >
              </div>
              <div
                class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
              >
                <span class="font-medium text-gray-700">Hourly Cost:</span>
                <span class="text-xl font-bold text-orange-600" id="hourly-cost"
                  >$0.00/hr</span
                >
              </div>
              <div
                class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
              >
                <span class="font-medium text-gray-700">Projected Daily:</span>
                <span
                  class="text-2xl font-extrabold text-red-600"
                  id="daily-cost"
                  >$0.00</span
                >
              </div>
            </div>
          </div>

          <div class="mt-6 text-sm text-gray-500 text-center">
            <p>
              API Status:
              <span id="api-status" class="font-semibold text-green-500"
                >Ready</span
              >
            </p>
            <p>Last Update: <span id="last-update">--</span></p>
          </div>
        </div>

        <!-- Live Power Chart Card -->
        <div class="lg:col-span-2 p-6 bg-white rounded-xl card">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">
            Live Power Draw (Watts)
          </h2>
          <canvas id="powerChart"></canvas>
        </div>
      </div>

      <!-- Energy Usage History Card -->
      <div class="mt-6 p-6 bg-white rounded-xl card">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">
          Energy Usage Trend (kW/h per Update)
        </h2>
        <canvas id="energyChart"></canvas>
      </div>
    </div>

    <script>
      // Device management
      let currentDeviceId = null;
      let devices = [];

      async function loadDevices() {
        try {
          const response = await fetch(
            "/.netlify/functions/get-smart-plug-data?action=list"
          );
          if (!response.ok) throw new Error("Failed to load devices");

          devices = await response.json();
          const selector = document.getElementById("device-selector");
          selector.innerHTML = devices
            .map(
              (d) => `<option value="${d.id}">${d.name} (${d.type})</option>`
            )
            .join("");

          // Select first device by default
          if (devices.length > 0) {
            currentDeviceId = devices[0].id;
            selector.value = currentDeviceId;
            updateDeviceInfo(devices[0]);
          }
        } catch (error) {
          console.error("Error loading devices:", error);
          document.getElementById("device-selector").innerHTML =
            '<option value="">Error loading devices</option>';
        }
      }

      function updateDeviceInfo(device) {
        document.getElementById("device-location").textContent =
          device.location;
        document.getElementById("appliance-name").textContent = device.name;
      }

      async function changeDevice(deviceId) {
        if (deviceId === currentDeviceId) return;

        currentDeviceId = deviceId;
        const device = devices.find((d) => d.id === deviceId);
        if (device) {
          updateDeviceInfo(device);
          // Reset charts
          powerData.labels = [];
          powerData.watts = [];
          powerData.kwh = [];
          powerData.cumulativeKWh = 0;
          powerChart.update();
          energyChart.update();
          // Fetch new device data
          await fetchDataAndRender();
        }
      }

      const MAX_DATA_POINTS = 30; // Max points to display in the chart
      let powerData = {
        labels: [],
        watts: [],
        kwh: [],
        cumulativeKWh: 0,
      };
      let lastUpdateTimestamp = Date.now();
      const updateIntervalMs = 3000; // API fetch interval (3 seconds)

      // --- CHART INITIALIZATION ---
      const powerCtx = document.getElementById("powerChart").getContext("2d");
      const powerChart = new Chart(powerCtx, {
        type: "line",
        data: {
          labels: powerData.labels,
          datasets: [
            {
              label: "Power (Watts)",
              data: powerData.watts,
              borderColor: "rgb(59, 130, 246)", // Blue
              backgroundColor: "rgba(59, 130, 246, 0.1)",
              borderWidth: 2,
              tension: 0.4,
              pointRadius: 3,
              fill: true,
            },
          ],
        },
        options: {
          responsive: true,
          animation: false,
          scales: {
            y: {
              title: { display: true, text: "Watts" },
              beginAtZero: true,
            },
            x: {
              title: { display: true, text: "Time" },
              display: true,
            },
          },
          plugins: {
            legend: { display: false },
            title: { display: false },
          },
        },
      });

      const energyCtx = document.getElementById("energyChart").getContext("2d");
      const energyChart = new Chart(energyCtx, {
        type: "bar",
        data: {
          labels: powerData.labels,
          datasets: [
            {
              label: "Energy Consumption (kWh)",
              data: powerData.kwh,
              backgroundColor: "rgb(168, 85, 247)",
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          animation: false,
          scales: {
            y: {
              title: { display: true, text: "Energy (kWh)" },
              beginAtZero: true,
            },
            x: {
              title: { display: true, text: "Time" },
              display: true,
            },
          },
          plugins: {
            legend: { display: false },
            title: { display: false },
          },
        },
      });

      /**
       * Fetches smart plug data by calling our secure Netlify serverless function.
       * @returns {Promise<{watts: number, device: string, timestamp: number}>}
       */
      async function getRealTimeSmartPlugData() {
        // This is the standard path to Netlify function.
        const apiEndpoint = `/.netlify/functions/get-smart-plug-data${
          currentDeviceId ? `?deviceId=${currentDeviceId}` : ""
        }`;

        const response = await fetch(apiEndpoint);

        if (!response.ok) {
          // Show error details if the serverless function fails
          const errorText = await response.text();
          throw new Error(`API function failed: ${errorText}`);
        }

        const data = await response.json();
        return data;
      }

      // DATA PROCESSING & CHART UPDATE
      function processAndRenderData(newData) {
        const now = new Date();
        const timeLabel = now.toLocaleTimeString();

        // 1. Calculate Energy (kWh) consumed since the last update
        const deltaMs = newData.timestamp - lastUpdateTimestamp;
        lastUpdateTimestamp = newData.timestamp;

        const powerInKW = newData.watts / 1000;
        const timeInHours = deltaMs / 3600000;
        const kwh_increment = powerInKW * timeInHours;

        // 2. Update Data Arrays (for charts)
        powerData.labels.push(timeLabel);
        powerData.watts.push(newData.watts);
        powerData.kwh.push(kwh_increment);

        // 3. Update Cumulative Energy
        powerData.cumulativeKWh += kwh_increment;

        // 4. Manage Data History (Sliding Window)
        if (powerData.labels.length > MAX_DATA_POINTS) {
          powerData.labels.shift();
          powerData.watts.shift();
          powerData.kwh.shift();
        }

        // 5. Update Charts
        // Use 'none' for animation to make it feel faster
        powerChart.update("none");
        energyChart.update("none");

        // 6. Update Dashboard Stats
        document.getElementById(
          "current-watts"
        ).textContent = `${newData.watts} W`;
        document.getElementById(
          "total-kwh"
        ).textContent = `${powerData.cumulativeKWh.toFixed(4)} kWh`;
        // Update device location if device info is available
        if (newData.device) {
          document.getElementById("device-location").textContent =
            newData.device.location;
        }
        document.getElementById("last-update").textContent = timeLabel;

        // Update cost information
        if (newData.energy) {
          document.getElementById(
            "rate-per-kwh"
          ).textContent = `$${newData.energy.ratePerKWh.toFixed(2)}/kWh`;
          document.getElementById(
            "hourly-cost"
          ).textContent = `$${newData.energy.hourlyCost.toFixed(3)}/hr`;
          document.getElementById(
            "daily-cost"
          ).textContent = `$${newData.energy.projectedDailyCost.toFixed(2)}`;
        }
      }

      //MAIN LOOP
      async function fetchDataAndRender() {
        document.getElementById("api-status").textContent = "Fetching...";
        document
          .getElementById("api-status")
          .classList.remove("text-green-500");
        document.getElementById("api-status").classList.add("text-yellow-600");

        try {
          const data = await getRealTimeSmartPlugData();
          processAndRenderData(data);

          document.getElementById("api-status").textContent = "Success";
          document
            .getElementById("api-status")
            .classList.remove("text-yellow-600", "text-red-600");
          document.getElementById("api-status").classList.add("text-green-500");
        } catch (error) {
          console.error("Failed to fetch smart plug data:", error);
          document.getElementById("api-status").textContent = "ERROR";
          document
            .getElementById("api-status")
            .classList.remove("text-yellow-600", "text-green-500");
          document.getElementById("api-status").classList.add("text-red-600");
        }
      }

      // Start the initial fetch immediately, then set the interval
      window.onload = function () {
        // Run updates on the charts once the page is loaded
        powerChart.update();
        energyChart.update();

        // Load available devices first
        loadDevices().then(() => {
          fetchDataAndRender(); // Initial data fetch
          // Set up the interval to mimic continuous API polling
          setInterval(fetchDataAndRender, updateIntervalMs);
        });
      };

      // Device control functionality
      let isDeviceOn = true; // Track device state

      async function toggleDevice() {
        const button = document.getElementById("toggle-button");
        button.disabled = true;
        button.classList.add("opacity-50");

        try {
          const response = await fetch(
            "/.netlify/functions/get-smart-plug-data",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ action: "toggle" }),
            }
          );

          if (!response.ok) {
            throw new Error("Failed to toggle device");
          }

          // Update button state
          isDeviceOn = !isDeviceOn;
          button.textContent = isDeviceOn ? "Turn OFF" : "Turn ON";

          // Fetch updated status
          await fetchDataAndRender();
        } catch (error) {
          console.error("Error toggling device:", error);
          alert("Failed to toggle device. Please try again.");
        } finally {
          button.disabled = false;
          button.classList.remove("opacity-50");
        }
      }
    </script>
  </body>
</html>
